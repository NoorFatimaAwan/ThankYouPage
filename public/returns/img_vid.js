var loadingSpinner = '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="margin: auto; background: none; display: block; shape-rendering: auto;" width="75px" height="75px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><g transform="rotate(0 50 50)"><rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="rgba(NaN, NaN, NaN, 0)"><animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.9166666666666666s" repeatCount="indefinite"></animate></rect></g><g transform="rotate(30 50 50)"><rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="rgba(NaN, NaN, NaN, 0)"><animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.8333333333333334s" repeatCount="indefinite"></animate></rect></g><g transform="rotate(60 50 50)"><rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="rgba(NaN, NaN, NaN, 0)"><animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.75s" repeatCount="indefinite"></animate></rect></g><g transform="rotate(90 50 50)"><rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="rgba(NaN, NaN, NaN, 0)"><animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.6666666666666666s" repeatCount="indefinite"></animate></rect></g><g transform="rotate(120 50 50)"><rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="rgba(NaN, NaN, NaN, 0)"><animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.5833333333333334s" repeatCount="indefinite"></animate></rect></g><g transform="rotate(150 50 50)"><rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="rgba(NaN, NaN, NaN, 0)"><animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.5s" repeatCount="indefinite"></animate></rect></g><g transform="rotate(180 50 50)"><rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="rgba(NaN, NaN, NaN, 0)"><animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.4166666666666667s" repeatCount="indefinite"></animate></rect></g><g transform="rotate(210 50 50)"><rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="rgba(NaN, NaN, NaN, 0)"><animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.3333333333333333s" repeatCount="indefinite"></animate></rect></g><g transform="rotate(240 50 50)"><rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="rgba(NaN, NaN, NaN, 0)"><animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.25s" repeatCount="indefinite"></animate></rect></g><g transform="rotate(270 50 50)"><rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="rgba(NaN, NaN, NaN, 0)"><animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.16666666666666666s" repeatCount="indefinite"></animate></rect></g><g transform="rotate(300 50 50)"><rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="rgba(NaN, NaN, NaN, 0)"><animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.08333333333333333s" repeatCount="indefinite"></animate></rect></g><g transform="rotate(330 50 50)"><rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="rgba(NaN, NaN, NaN, 0)"><animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="0s" repeatCount="indefinite"></animate></rect></g><!-- [ldio] generated by https://loading.io/ --></svg>';

(function() {
  var loadPlugin = function() {
    const variant_titles = []
    var host_url = "https://mcacao.phaedrasolutions.com"
    const substring = 'expressio'
    let total_products = 0
    for(let x = 0; x < Shopify.checkout.line_items.length; x++){
      variant_titles.push((Shopify.checkout.line_items[x].title.toLowerCase()).includes(substring))
      total_products = total_products + Shopify.checkout.line_items[x].quantity
    }
    if (variant_titles.every(Boolean))
    {
      fetch("",{mode: "no-cors"})
          .then(response => response)
          .then(data => {
            if (true)
            {
              document.getElementById('main-header').innerHTML = "Hi " + Shopify.checkout.billing_address.first_name + "!"
              if (document.getElementsByClassName('content-box__row--no-padding')[0] != undefined)
              {
                document.getElementsByClassName('content-box__row--no-padding')[0].setAttribute('style', 'display:none;')
              }
              if (document.getElementsByClassName('content-box')[0] != undefined)
              {
                document.getElementsByClassName('content-box')[0].setAttribute('style','display:none;');
              }
              let question_body = document.createElement("body")
              let question_container = document.createElement("object")
              question_body.setAttribute("id", "question_body");
              question_body.append(question_container)
              question_container.setAttribute("id","question_container")
              question_body.setAttribute("style","position: relative;border-radius: 4px; margin-top: 30px;overflow:hidden;" )
              question_container.setAttribute("style","width: 100%;min-height: 170px;overflow:hidden;");
              parameters = `user_email=${Shopify.checkout.email}&order_no=${document.getElementsByClassName('os-order-number')[0].innerText.trim().split("#")[1]}&user_name=${Shopify.checkout.billing_address.first_name}&thank_you_page_url=${window.location.href}&order_id=${Shopify.checkout.order_id}&total_products=${total_products}`
              question_container.setAttribute("data", `${host_url}/orders/should_show?${parameters}`)
              document.getElementsByClassName('os-header__heading')[0].after(question_body)
              let body = document.createElement("body")
              let product_index = 0;
              for(let x = 0; x < Shopify.checkout.line_items.length; x++)
              {
                for (let step = 0; step < Shopify.checkout.line_items[x].quantity; step++){
                  let container = document.createElement("object")
                  body.setAttribute("id", "assistalong-reminder-body");
                  body.append(container)
                  container.setAttribute("id","thank_you_container")    
                  if (navigator.userAgent.match(/android|iphone|kindle|ipad/i) != null)
                  {
                    container.setAttribute("style","width: 100%;min-height: 409px; border-bottom:1px solid #7a5e4679;overflow:hidden;");
                  }
                  else
                  {
                    container.setAttribute("style","width: 100%;min-height: 220px; border-bottom:1px solid #7a5e4679;overflow:hidden;");
                  }
                  body.setAttribute("style","position: relative;min-height: 150px;border: 1px solid #7A5E464D; border-radius: 4px; margin-top: 30px;overflow:hidden;" ) 
                  container.setAttribute("type", "text/html")
                   const loadState = document.createElement("div")
                   loadState.setAttribute("style",'display:flex;position:absolute;z-index:9999;top:0;bottom:0;right:0;left:0;background-color: #fffc;')
                   loadState.innerHTML += loadingSpinner;
                   body.append(loadState);
                   body.style.display = "block"
                   if (x == 0)
                   {
                    index = 0
                   }
                   else
                   {
                    index = x-1
                   }
                  length = Shopify.checkout.line_items[index].quantity
                  product_index++;
                  parent_product_id = Shopify.checkout.line_items[index].variant_id
                  options = `total_products=${total_products}&order_id=${Shopify.checkout.order_id}&thank_you_page_url=${window.location.href}&product_index=${product_index}&user_name=${Shopify.checkout.billing_address.first_name}&first_variant_title=${Shopify.checkout.line_items[0].variant_title}&first_product_title=${Shopify.checkout.line_items[0].title}&product_no=${step}&order_no=${document.getElementsByClassName('os-order-number')[0].innerText.trim().split("#")[1]}&product_length=${length}&domain=${Shopify.shop}&parent_product_id=${parent_product_id}&product_id=${Shopify.checkout.line_items[x].variant_id}&product_title=${Shopify.checkout.line_items[x].title}&product_image_url=${Shopify.checkout.line_items[x].image_url}&user_email=${Shopify.checkout.email}&variant_title=${Shopify.checkout.line_items[x].variant_title}`
                  container.onload  = function() {
                     setTimeout(() => {
                      container.contentWindow.postMessage('message',host_url);
                      }, 50)
                   loadState.remove();
                  }
                  container.setAttribute("data", `${host_url}/orders/new?${options}`)
                  document.getElementsByClassName("section")[0].after(body)  
                }   
              }
            }
    
      });
    }


  }

  loadPlugin();
})();


